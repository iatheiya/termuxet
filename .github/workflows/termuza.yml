name: termuza

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

env:
  JAVA_VERSION: '17'
  API_LEVEL: '30'
  ANDROID_TARGET: 'aosp_atd'
  ANDROID_ARCH: 'x86_64'
  AVD_NAME: 'ci_optimized'
  EMU_BOOT_TIMEOUT_SEC: '600'
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs=-Xmx2560m -XX:+UseParallelGC"

jobs:
  diagnostics:
    name: diagnostics
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle
      - run: chmod +x ./gradlew
      - name: check-kvm
        run: |
          echo "Checking KVM..."
          if [ -r /dev/kvm ]; then
            echo "KVM is available"
            echo "kvm_available=true" >> $GITHUB_ENV
          else
            echo "KVM NOT available"
            echo "kvm_available=false" >> $GITHUB_ENV
          fi
          echo "=== /proc/cpuinfo ===" > diagnostics_kvm.txt
          cat /proc/cpuinfo >> diagnostics_kvm.txt 2>/dev/null || true
          echo "=== lsmod | grep kvm ===" >> diagnostics_kvm.txt
          lsmod | grep kvm >> diagnostics_kvm.txt 2>/dev/null || true
          echo "=== dmesg last lines ===" >> diagnostics_kvm.txt
          dmesg | tail -n 50 >> diagnostics_kvm.txt 2>/dev/null || true
      - name: unit-tests-debug
        continue-on-error: true
        run: |
          RUNID=${{ github.run_id }}
          OUT="diagnostics-${RUNID}-unit-debug.txt"
          ./gradlew testDebugUnitTest --stacktrace 2>&1 | tee "$OUT" || true
      - name: lint-check
        continue-on-error: true
        run: |
          RUNID=${{ github.run_id }}
          OUT="diagnostics-${RUNID}-lint.txt"
          ./gradlew lint --stacktrace 2>&1 | tee "$OUT" || true
      - name: collect-diagnostics
        if: always()
        run: |
          mkdir -p diagnostics_out
          mv diagnostics-*.txt diagnostics_out/ 2>/dev/null || true
          mv diagnostics_kvm.txt diagnostics_out/ 2>/dev/null || true
          if [ -d "app/build/reports" ]; then cp -r app/build/reports diagnostics_out/reports; fi
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: diagnostics-data
          path: diagnostics_out

  build:
    name: build
    runs-on: ubuntu-latest
    needs: diagnostics
    if: always()
    timeout-minutes: 40
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle
      - uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 11076708
      - run: chmod +x ./gradlew
      - name: prepare-keystore
        run: |
          if [ -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > release.keystore
          else
            keytool -genkeypair -v -keystore release.keystore -alias ci_release -storepass android -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=CI,OU=CI,O=CI,L=CI,ST=CI,C=US"
          fi
      - name: assemble-release
        continue-on-error: true
        run: |
          RUNID=${{ github.run_id }}
          OUT="build-${RUNID}-assemble.txt"
          ./gradlew clean assembleRelease --stacktrace 2>&1 | tee "$OUT" || true
      - name: find-apk
        id: find_apk
        run: |
          APK="$(find app/build/outputs/apk -type f -name "*.apk" ! -name "*-unaligned.apk" | head -n 1 || true)"
          if [ -n "$APK" ]; then
            echo "apk_path=$APK" >> $GITHUB_OUTPUT
            echo "apk_exists=true" >> $GITHUB_ENV
            echo "Found APK: $APK"
          else
            echo "apk_exists=false" >> $GITHUB_ENV
            echo "No APK found."
          fi
      - name: analyze-native-libs
        if: env.apk_exists == 'true'
        run: |
          APK="${{ steps.find_apk.outputs.apk_path }}"
          mkdir -p build_out
          unzip -l "$APK" | grep "lib/" > native_libs_structure.txt || echo "NO_NATIVE_LIBS" > native_libs_structure.txt
          mv native_libs_structure.txt build_out/ || true
      - name: analyze-manifest
        if: always()
        run: |
          find app/build -name "AndroidManifest.xml" -print0 | xargs -0 grep -E "exported|permission|activity" > manifest_analysis.txt || echo "Manifest not found" > manifest_analysis.txt
          mkdir -p build_out
          mv manifest_analysis.txt build_out/ || true
      - name: collect-build-logs
        if: always()
        run: |
          mkdir -p build_out
          mv build-*.txt build_out/ 2>/dev/null || true
          mv build_out build_out || true
          find app/build/outputs/apk -name "*.apk" -exec cp {} build_out/ \; 2>/dev/null || true
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-data
          path: build_out

  emulator:
    name: emulator
    runs-on: ubuntu-latest
    needs: build
    if: always()
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
      - uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 11076708
      - uses: actions/download-artifact@v4
        with:
          name: build-data
          path: downloaded_apk
      - name: identify-apk
        id: find_apk
        run: |
          APK="$(find downloaded_apk -type f -name "*.apk" | head -n 1 || true)"
          if [ -n "$APK" ]; then
            echo "apk_path=$APK" >> $GITHUB_OUTPUT
            echo "apk_exists=true" >> $GITHUB_ENV
          else
            echo "apk_exists=false" >> $GITHUB_ENV
          fi
      - name: setup-avd-optimized
        if: env.apk_exists == 'true'
        run: |
          set -euo pipefail
          export ANDROID_SDK_ROOT="${ANDROID_SDK_ROOT:-$HOME/Android/Sdk}"
          export ANDROID_HOME="$ANDROID_SDK_ROOT"
          export PATH="$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$PATH"
          mkdir -p "$ANDROID_HOME"
          mkdir -p "$HOME/.android/avd"
          yes | sdkmanager --sdk_root="$ANDROID_HOME" "platform-tools" "emulator" "system-images;android-${{ env.API_LEVEL }};${{ env.ANDROID_TARGET }};${{ env.ANDROID_ARCH }}" || true
          yes | sdkmanager --sdk_root="$ANDROID_HOME" --licenses || true
          avdmanager create avd -n "${AVD_NAME}" -k "system-images;android-${{ env.API_LEVEL }};${{ env.ANDROID_TARGET }};${{ env.ANDROID_ARCH }}" --device "pixel" --force || true
          CONFIG_DIR="$HOME/.android/avd/${AVD_NAME}.avd"
          CONFIG_PATH="$CONFIG_DIR/config.ini"
          for i in 1 2 3 4 5; do
            if [ -f "$CONFIG_PATH" ]; then break; fi
            sleep 2
          done
          mkdir -p "$CONFIG_DIR"
          cat >> "$CONFIG_PATH" <<'EOF'
hw.ramSize=2048
vm.heapSize=256
hw.lcd.density=160
hw.lcd.height=800
hw.lcd.width=480
hw.accelerometer=no
hw.audioInput=no
hw.battery=no
hw.gps=no
EOF
          echo "AVD Configured. Cat config for debug:"
          cat "$CONFIG_PATH" || true
      - name: run-emulator-and-test
        if: env.apk_exists == 'true'
        continue-on-error: true
        run: |
          set -euo pipefail
          export ANDROID_SDK_ROOT="${ANDROID_SDK_ROOT:-$HOME/Android/Sdk}"
          export ANDROID_HOME="$ANDROID_SDK_ROOT"
          export PATH="$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator:$ANDROID_HOME/cmdline-tools/latest/bin:$PATH"
          APK="${{ steps.find_apk.outputs.apk_path }}"
          LOGDIR="emulator_logs"
          mkdir -p "$LOGDIR"
          echo "kvm_available=${{ env.kvm_available }}" > "$LOGDIR/kvm_flag.txt"
          if [ "${{ env.kvm_available }}" = "true" ] && [ -r /dev/kvm ]; then
            ACCEL_FLAG="-accel on"
            sudo chmod 666 /dev/kvm || true
          else
            ACCEL_FLAG="-accel off"
          fi
          adb kill-server || true
          adb start-server || true
          (while true; do date; free -h; sleep 60; done) > "$LOGDIR/memory_monitor.txt" &
          EMU_STDOUT="$LOGDIR/emu_stdout.txt"
          EMU_STDERR="$LOGDIR/emu_stderr.txt"
          stdbuf -oL emulator -avd "${AVD_NAME}" -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect $ACCEL_FLAG -no-snapshot -camera-back none >"$EMU_STDOUT" 2>"$EMU_STDERR" &
          EMU_PID=$!
          START_TIME=$(date +%s)
          BOOT_SUCCESS=false
          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$(( CURRENT_TIME - START_TIME ))
            if ! kill -0 $EMU_PID 2>/dev/null; then
              echo "CRITICAL: Emulator process died!" | tee "$LOGDIR/boot_error.txt"
              break
            fi
            STATUS=$(timeout 5s adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r' || true)
            if [ "$STATUS" = "1" ]; then
              echo "SUCCESS: Boot completed in ${ELAPSED}s"
              BOOT_SUCCESS=true
              break
            fi
            if [ $ELAPSED -ge ${{ env.EMU_BOOT_TIMEOUT_SEC }} ]; then
              echo "TIMEOUT: Boot time limit exceeded." | tee "$LOGDIR/boot_error.txt"
              break
            fi
            if (( ELAPSED % 30 == 0 )); then
              echo "HEARTBEAT: Waiting... ${ELAPSED}s. ADB State: $(adb get-state 2>/dev/null || echo 'unknown')"
            fi
            sleep 5
          done
          if [ "$BOOT_SUCCESS" = "true" ]; then
            sleep 10
            adb wait-for-device
            adb logcat -c || true
            if timeout 120s adb install -r "$APK" > "$LOGDIR/install_log.txt" 2>&1; then
              echo "APK Installed."
              BUILD_TOOLS_DIR="$(ls -d $ANDROID_HOME/build-tools/*/ 2>/dev/null | sort -V | tail -n 1 || true)"
              AAPT="$BUILD_TOOLS_DIR/aapt"
              if [ -x "$AAPT" ]; then
                PKG=$($AAPT dump badging "$APK" | grep "package: name=" | awk -F"'" '{print $2}' || true)
                ACT=$($AAPT dump badging "$APK" | grep "launchable-activity: name=" | awk -F"'" '{print $2}' || true)
              else
                PKG=$(unzip -p "$APK" AndroidManifest.xml 2>/dev/null | strings | head -n 1 || true)
                ACT=""
              fi
              if [ -n "$PKG" ]; then
                if [ -n "$ACT" ]; then
                  adb shell am start -n "$PKG/$ACT" || true
                else
                  adb shell monkey -p "$PKG" 1 || true
                fi
                sleep 30
                adb logcat -d > "$LOGDIR/full_logcat.txt" || true
                grep -E "FATAL|AndroidRuntime|Exception|Caused by|ANR" "$LOGDIR/full_logcat.txt" > "$LOGDIR/runtime_crashes.txt" || echo "No crashes found in grep." > "$LOGDIR/runtime_crashes.txt"
              else
                echo "Error: Package name not found in APK." > "$LOGDIR/parse_error.txt"
              fi
            else
              echo "Install Failed." > "$LOGDIR/install_error.txt"
            fi
            adb emu kill || kill -9 $EMU_PID 2>/dev/null || true
          else
            echo "Boot failed. Collecting stderr..." > "$LOGDIR/boot_failure_log.txt"
            cp "$EMU_STDERR" "$LOGDIR/boot_failure_log.txt" || true
            kill -9 $EMU_PID 2>/dev/null || true
          fi
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: emulator-data
          path: emulator_logs

  report:
    name: final-report
    runs-on: ubuntu-latest
    needs: [diagnostics, build, emulator]
    if: always()
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: artifacts
      - name: generate-strict-report
        run: |
          OUT="FULL_STRICT_REPORT.txt"
          touch "$OUT"
          echo "=== STRICT CI REPORT ===" >> "$OUT"
          echo "Timestamp: $(date)" >> "$OUT"
          echo "Run ID: ${{ github.run_id }}" >> "$OUT"
          echo "========================" >> "$OUT"
          echo "" >> "$OUT"
          echo "[SECTION: RUNTIME CRASHES]" >> "$OUT"
          if find artifacts -name "runtime_crashes.txt" -type f -exec grep -q "." {} \; ; then
             find artifacts -name "runtime_crashes.txt" -type f -exec cat {} + >> "$OUT"
          else
             echo "No Runtime Crashes Detected." >> "$OUT"
          fi
          if find artifacts -name "boot_error.txt" -type f -print -quit | grep -q . ; then
             echo "CRITICAL FAILURE: EMULATOR DID NOT BOOT" >> "$OUT"
          fi
          if find artifacts -name "install_error.txt" -type f -print -quit | grep -q . ; then
             echo "CRITICAL FAILURE: APK INSTALLATION FAILED" >> "$OUT"
          fi
          echo "" >> "$OUT"
          echo "[SECTION: BUILD ERRORS]" >> "$OUT"
          find artifacts -name "build-*-assemble.txt" -type f -exec grep -E "FAILURE|FAILED|Error:" {} + >> "$OUT" || true
          echo "" >> "$OUT"
          echo "[SECTION: UNIT TEST FAILURES]" >> "$OUT"
          find artifacts -name "diagnostics-*-unit-*.txt" -type f -exec grep -E "FAILED|FAILURE" {} + >> "$OUT" || true
          echo "" >> "$OUT"
          echo "[SECTION: LINT SUMMARY]" >> "$OUT"
          find artifacts -name "diagnostics-*-lint.txt" -type f -exec grep -E "Error" {} + | head -n 200 >> "$OUT" || true
          echo "" >> "$OUT"
          echo "[SECTION: NATIVE LIBS]" >> "$OUT"
          find artifacts -name "native_libs_structure.txt" -type f -exec cat {} + >> "$OUT" || true
          echo "" >> "$OUT"
          echo "[SECTION: EMULATOR STDERR (LAST 200 LINES)]" >> "$OUT"
          find artifacts -name "emu_stderr.txt" -type f -exec tail -n 200 {} + >> "$OUT" || true
          echo "" >> "$OUT"
          echo "[SECTION: MEMORY MONITOR SNAPSHOT]" >> "$OUT"
          find artifacts -name "memory_monitor.txt" -type f -exec tail -n 20 {} + >> "$OUT" || true
      - uses: actions/upload-artifact@v4
        with:
          name: FINAL_REPORT
          path: FULL_STRICT_REPORT.txt
